---
title: "Defining parameters to identify isotopologue peaks using [M], [M+H], [M+k], [M+Cl] from HMDB"
author: "Andrea Vicini, Vinicius Verri Hernandez, Johannes Rainer"
output:
  rmarkdown::html_document:
    highlight: pygments
    toc: true
    toc_depth: 3
    fig_width: 5
---

```{r style, echo = FALSE, results = 'asis', message = FALSE}
library(BiocStyle)
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

**Last modified:** `r file.info("isotope-intensity-estimation.Rmd")$mtime`<br />
**Compiled**: `r date()`

$\require{mhchem}$

# Introduction

In this document we evaluate the substitutions parameters that can be obtained 
from the the adducts [M+Cl] of the human metabolom database (HMDB) compounds.

```{r libraries, warning = FALSE}
library("CompoundDb")
library("MetaboCoreUtils")
library("pander")
library("enviPat")
```

We load the HMDB database and extract the chemical formula and exact mass of all
compounds.

```{r}
cdb <- CompDb("data/CompDb.Hsapiens.HMDB.4.0.sqlite")
cmps <- compounds(cdb, columns = c("compound_id", "name",
                                   "formula", "exactmass"))
```

For each compound in the HMDB with available mass we compute the counts of 
the atoms that are present in it and collect them in a data frame with a 
column for each element and a row for each compound in HMDB.

```{r}
cmps <- cmps[-which(is.na(cmps$exactmass)), ]
```

```{r}
tmp <- lapply(cmps$formula, function(frml) res <- countElements(frml))
elements_names <- unique(names(unlist(tmp)))
counts <- lapply(tmp, function(x) {
  row <- numeric(length(elements_names))
  names(row) <- elements_names
  row[names(x)] <- x
  row
  })
counts_df <- data.frame(do.call(rbind, counts))
rownames(counts_df) <- cmps$compound_id
```

```{r}
CHNOPSCl <- c("C", "H", "N", "O", "P", "S", "Cl")
onlyCHNOPSCl <- rowSums(counts_df[, setdiff(elements_names, CHNOPSCl)]) == 0

# With the following lines we can exclude compounds that have some atoms of
# elements different from CHNOPSCl.
cmps <- cmps[onlyCHNOPSCl, ]
counts_df <- counts_df[onlyCHNOPSCl, ]
```

We derive the counts of the adducts [M+Cl] and from them the their formulas.

```{r}
counts_df_H <- counts_df_K <- counts_df_Na <- counts_df
counts_df_H$H <- counts_df$H + 1
counts_df_K$K <- counts_df$K + 1
counts_df_Na$Na <- counts_df$Na + 1
counts_df <- rbind(counts_df_H, counts_df_K, counts_df_Na)
adducts_frmls <- apply(counts_df, 1, function(elements) pasteElements(elements))
```

### Identification of the most frequent isotopic substitutions {#isotopologues}

We next aim at identifying, for all compounds present in HMDB, the most 
frequently observed isotopic substitutions considering all possible 
isotopologues for each molecule.

To this end we calculate the isotope pattern for each compound in HMDB using
`enviPat` and identify isotopologues which would result in an intensity
higher than 10^(-4). For each of these peaks we define its *substitution id* which
consists of the heavier isotopes characterizing the associated isotopologue,
e.g. `"[13]C4[15]N2"` and determine the frequency of each substitution in HMDB.

```{r, echo = FALSE}
dr <- paste0("data/RData/isotope-intensity-estimation/")
dir.create(dr, showWarnings = FALSE, recursive = TRUE)
```

```{r}
data(isotopes)
# isos <- c("13C", "2H", "15N", "17O", "18O", "33S", "34S", "35S", "36S",
#           "36Cl", "37Cl")
isos <- isotopes$isotope[-match(unique(isotopes$element), isotopes$element)]
```

```{r, eval = !file.exists(paste0(dr, "subst_frequencies_all.RData"))}
## Ensure that element order is correct
chemforms <- sapply(adducts_frmls, standardizeFormula)
threshold <- 0.01 * 10^(-2)
iso_ps <- isopattern(isotopes, chemforms , threshold = threshold, rel_to = 2) 

## Define the isotopologue name for each substitution - ensuring the order of
## isotopes to be the same across compounds
iso_ps <- lapply(iso_ps, function(iso_p) {
    idx <- match(colnames(iso_p), isos)
    tmp <- iso_p[, !is.na(idx), drop = FALSE]
    mono_iso <- rowSums(tmp) == 0
    tmp <- tmp[!mono_iso, order(idx[!is.na(idx)]), drop = FALSE]
    cn <- colnames(tmp)
    elname <- gsub('[0-9]', '', cn)
    isonumb <- gsub('[^0-9]', '', cn)
    nms <- rep("", nrow(iso_p))
    nms[!mono_iso] <- apply(tmp, 1, function(row)
        paste0("[", isonumb[row > 0],  "]", elname[row > 0], row[row > 0], 
               collapse = ""))
    nms[mono_iso] <- "mono"
    rownames(iso_p) <- nms
    iso_p
})

subst_per_cmpd <- lapply(iso_ps, function(z) rownames(z)[rownames(z) != "mono"])
subst_frequency <- table(unlist(subst_per_cmpd, use.names = FALSE))
save(subst_frequency, subst_per_cmpd, 
     iso_ps, chemforms, file = paste0(dr, "subst_frequencies_all.RData"))
```


```{r, echo = FALSE, eval = file.exists(paste0(dr, "subst_frequencies_all.RData"))}
load(paste0(dr, "subst_frequencies_all.RData"))
```

We thus defined `r length(subst_frequency)` substitutions that in at least a 
compound in HMBD would yield a probability higher than 10^(-4).

For each given substitution we compute the mean intensity it has in the
compounds of HMBD where it was found to result in a peak higher then the set
threshold.

```{r}
intens <- unlist(lapply(iso_ps, function(iso_p) {
    iso_p[rownames(iso_p) != "mono", "abundance"]
}), use.names = FALSE)
m_intens_subs <- tapply(intens, unlist(subst_per_cmpd, use.names = FALSE), mean)
```

and plot it against the frequency of the substitution in HMBD. Most of the 
substitution present a small mean intensity. Most of the substitution with mean 
intensity higher than 5 are those related to Cl (these are not very frequent) 
and C.

```{r}
library(ggplot2)
library(plotly)
p <- data.frame(subst_name = names(m_intens_subs),
  subst_frequency = as.numeric(subst_frequency), 
                intens = m_intens_subs) %>%
ggplot(aes(subst_frequency, intens, label = subst_name)) + geom_point()
ggplotly(p)
```

We next identify the *most frequently* observed substitutions in compounds of
HMDB using 3 different approaches.

In the first approach we simply select the substitutions found in 50% of
compounds to yield an intensity larger than the set threshold.

```{r, fig.height = 5, fig.width = 9, fig.cap = "Substitutions with proportion > 0.5 using approach 1"}
subst_proportion <- sort(subst_frequency / nrow(cmps), decreasing = TRUE)
par(mar = c(8, 4.1, 4.1, 2.1), mfrow = c(1, 1))
barplot(subst_proportion[subst_proportion > 0.5], las = 2)
```

In the plot above we can see substitutions for compounds in HMBD that produce a
*significant* peak for at least a half of the compounds (the height of the bar
specifies the exact proportion). In other words, if we randomly sample a
compound in HMBD the chance to observe a significant peak related to the 
isotopologues associated to the above substitutions will be high. Because of the 
high frequency of C, H and O elements in compounds of HMDB, this selection is 
heavily biased by isotopes of these elements.

Thus, in the second approach we compare the frequency of a substititution against
the number of compounds in HMDB that contain each of the elements from the
isotopologue definition in their chemical formula.

```{r}
ncomps <- vapply(names(subst_frequency), function(x) {
    x <- strsplit(gsub("[0-9\\[]+", "", x), split = "\\]")[[1]][-1]
    sum(rowSums(counts_df[, x, drop = FALSE] > 0) == length(x))
}, integer(1))
```

```{r, fig.height = 5, fig.width = 17, fig.cap= "Substitutions with proportion > 0.5 using approach 2"}
subst_proportion_var <- sort(subst_frequency/ncomps, decreasing = TRUE)
par(mar = c(10, 4.1, 4.1, 2.1))
barplot(subst_proportion_var[subst_proportion_var > 0.5], las = 2)
```

```{r, fig.height = 5, fig.width = 10, fig.cap = "Proportions computed according the second approach and mean intensities for the substitutions. The substitutions on the right of the red line correspond to the columns in the previous barplot"}
p <- data.frame( subst_name = names(m_intens_subs),
  proportion_var = as.numeric(subst_frequency/ncomps), 
                intens = m_intens_subs) %>%
ggplot(aes(proportion_var, intens, label = subst_name)) + geom_point()
ggplotly(p + geom_vline(xintercept = 0.5, color = "red", size = .1))
```

Third approach. Here we also try to divide the counts of the times a 
substitution is found to be significant in the HMBD compounds for the times that 
this substitution can be observed across the HMBD compounds. In other words these 
ratios represent the likelihood to find a substitution significant among the 
subset of HMBD compounds that have it as possible substitution (this happens 
when, for each element $X$ in the compound, the number of atoms of $X$ is >= 
than the sum of the numbers ${n_X}_2$, ..., ${n_X}_q$ of heavier isotopes 
associated to the substitution).

```{r}
count_heavy_iso <- function(subst_str){
  tmp <- sapply(strsplit(subst_str, split = "\\[")[[1]][-1], 
                function(s) strsplit(s, split ="\\]")[[1]][2])
  tapply(as.numeric(gsub('[^0-9]+', '', tmp)), gsub('[0-9]+', '', tmp), sum)
}

nvar <- sapply(names(subst_frequency), function(subst) {
  els <- count_heavy_iso(subst)
  var <- rep(TRUE, nrow(counts_df))
  for (el in names(els)) 
    var <- var & (counts_df[, el] >= els[el])
  sum(var)
})
```

```{r, fig.height = 5, fig.width = 17, fig.cap = "Substitutions with proportion > 0.5 using approach 3"}
subst_proportion_var2 <- sort(subst_frequency/nvar, decreasing = TRUE)
par(mar = c(10, 4.1, 4.1, 2.1))
barplot(subst_proportion_var2[subst_proportion_var2 > 0.5], las = 2)
```

In the plot above we can see the substitutions that produce a significant 
peak for at least a half of the compounds in which they are possible. 
(the height of the bar specifies the exact proportion). In this case we observe 
also families where N, S or Cl in them. 
To exemplify the difference, all molecules (the proportion in the above plot is 
1) of HMBD that have at least 1 atom of C and 1 atom of Cl are found to have 
significant peaks corresponding to [13]C1[37]Cl1. However, since the number of 
such compounds in HMBD is very low the probability of observing the effect of 
such a substitution is very very low if we randomly pick one compound in HMBD.

In the following plot we show also the mean intensity of the substitutions. 
According to the third approach we select substitutions of Cl which have high 
mean intensity but were excluded with the first two approaches.

```{r, fig.height = 5, fig.width = 10, fig.cap = "Proportions computed according the third approach and mean intensities for the substitutions. The substitutions on the right of the red line correspond to the columns in the previous barplot"}
library(ggplot2)
library(plotly)
par(mfrow= c(1,2))
p <- data.frame(subst_name = names(m_intens_subs),
                proportion_var2 = as.numeric(subst_frequency/nvar), 
                intens = m_intens_subs) %>%
ggplot(aes(proportion_var2, intens, label = subst_name)) + geom_point()
ggplotly(p + geom_vline(xintercept = 0.5, color = "red", size= .1))
```

We thus select substitutions defined by approach 3 as the *most frequently
observed substitutions*. 

```{r}
selected_substs <- names(subst_proportion_var2[subst_proportion_var2 > 0.5])
```

### Defining mass difference and intensity (probability) ratios

We next compute for all of the isotopologues (associated with the selected 
substitutions) their mass difference $md$ and subsequently also the observed 
intensity (probability) ratios between monoisotopic peak and isotopologue peak.

```{r}
## Calculate mass differences and intensity (probability) ratios for all
## isotopologues; putting all into a data.frame for easier data processing
iso_data <- lapply(iso_ps, function(z) {
    mono <- which(rownames(z) == "mono")
    if (length(mono) == 1L) {
        res <- data.frame(isotopologue = rownames(z),
                          md = z[, "m/z"] - z[mono, "m/z"],
                          R = z[, "abundance"] / z[mono, "abundance"],
                          z[, c("m/z", "abundance"), drop = FALSE],
                          monomass = z[mono, "m/z"],
                          check.names = FALSE)
        res[-mono, , drop = FALSE]
    } else {
        data.frame(isotopologue = rownames(z),
                   md = NA_real_,
                   R = NA_real_,
                   z[, c("m/z", "abundance"), drop = FALSE],
                   monomass = NA_real_,
                   check.names = FALSE)
    }
})
cnts <- vapply(iso_data, nrow, integer(1))
iso_data <- do.call(rbind, iso_data)
rownames(iso_data) <- NULL
iso_data$formula <- rep(adducts_frmls, cnts)
iso_data$hmdb_id <- rep(rownames(counts_df), cnts)

## subset to selected isotopologues
iso_data_sub <- iso_data[iso_data$isotopologue %in% selected_substs, ]
```

We next extract the mass difference $md$ for each isotopologue.

```{r}
## Calculate the md for each substitution
md <- vapply(split(iso_data$md, iso_data$isotopologue)[selected_substs],
             mean, numeric(1))
```

And finally also the ratios $R$ for each isotopologue.

```{r}
R <- split(iso_data$R, iso_data$isotopologue)[selected_substs]
```

<!-- I think this is no longer needed if we create bounds directly on untransformed R

For each isotopologue we have thus defined the observed intensity (probability)
ratio for compounds in HMDB. The probability of the combination of isotopes for
a single element is depending on the number of atoms of that element in a
compound and the probability of an isotopologue (i.e. several different isotopes
occurring in the same compound) is equal to the product of the probabilities of
the individual isotopes. Also, there needs to be a relationship between a
compounds mass and the number of atoms its build of, with heavier compounds
consisting of a larger number of atoms. 
For some elements clearly a linear relationship between the element count and
the compound's mass is visible. The ratio of the probabilities between the
isotopologue and its monoisotopic form depends only on the probabilities of the
combination of isotopes of a given element forming the substitution. These
probabilities are products on the individual isotopes' probabilities (which
depend on the total number of atoms of the isotope's element). Given the
relationship between the element count and the compounds mass is linear, we can
expect the relationship between the probability ratio $R$ and the compound's
mass to be polynomial with degree depending on the number of atoms in the
substitution.

We thus next determine the degree of the expected polynomial trend by computing
the number of atoms which appear in the substitutions.

```{r}
sbst_degree <- sapply(
    selected_substs, function(string) sum(count_heavy_iso(string)))
iso_data_sub$degree <- sbst_degree[match(iso_data_sub$isotopologue,
                                         names(sbst_degree))]
```

We next transform the data by taking the $x$-th root of $R$ for each 
isotopologue (with $x$ being the degree of the polynomial for each
isotopologue).

```{r}
iso_data_sub$`R_` <- iso_data_sub$R^(1 / iso_data_sub$degree)
```

We next calculate the ratios between all such transformed $\hat{R}$ of all
isotopologues and the mass of the respective compound. These represent the
slopes from (0, 0) to each data point in the mass - by - $\hat{R}$ space. For
each isotopologue we then determine an upper and lower quantile of these slopes
which we will use as an upper and lower bound for the estimation of the
$\hat{R}$ from a unknown compound's mass.

```{r}
iso_data_sub$slope <- iso_data_sub$R_ / iso_data_sub$monomass
iso_slope_q <- lapply(split(iso_data_sub$slope, iso_data_sub$isotopologue),
                      function(x) quantile(x, c(0.005, 0.995), na.rm = TRUE))
```

We next plot the relationship between the transformed $\hat{R}$ and the
compound masses for all selected isotopologue.

```{r, echo = FALSE}
f <- rep(seq(ceiling(length(selected_substs)/9)), each = 9)[seq_along(selected_substs)]
plts <- split(sort(selected_substs), f)

tmp <- lapply(plts, function(z) {
    par(mfrow = c(3, 3), mar = c(4.2, 4.2, 2, 0.5))
    for (iso in z) {
        idx <- which(iso_data_sub$isotopologue == iso)
        plot(iso_data_sub$monomass[idx], iso_data_sub$R_[idx],
             main = iso, xlab = "monoisotopic mass", ylab = expression(hat(R)),
             pch = 16, col = "#00000040", cex = 0.75)
        abline(0, iso_slope_q[[iso]][2L], col = "#377EB880")
        abline(0, iso_slope_q[[iso]][1L], col = "#4DAF4A80")
    }
})
```

We can observe a linear trend for each substitution in the transformed data
(especially for the substitutions containing only elements with clear linear
trend of the counts in the mass as observed before).

Finally, we create the substitution definition `data.frame`. For each
substitution (row) we report its name, the degree of the polynomial, the mass
difference $md$, the lowest monoisotopic mass among the compounds which admit 
the substitution, and the lower and upper bounds on $\hat{R}$.

```{r}
f <- factor(iso_data_sub$isotopologue)
hmdb_subst <- data.frame(
    name = levels(f),
    degree = iso_data_sub$degree[match(levels(f), iso_data_sub$isotopologue)],
    minmass = vapply(split(iso_data_sub$monomass, f), min, numeric(1)),
    md = iso_data_sub$md[match(levels(f), iso_data_sub$isotopologue)],
    min_slope = vapply(iso_slope_q[levels(f)], "[", numeric(1), 1L),
    max_slope = vapply(iso_slope_q[levels(f)], "[", numeric(1), 2L)
)
hmdb_subst <- hmdb_subst[order(hmdb_subst$md), ]
```


```{r}
dr_txt <- paste0("data/txt/isotope-intensity-estimation/")
dir.create(dr, showWarnings = FALSE, recursive = TRUE)
write.table(hmdb_subst, file = paste0(dr_txt, "hmdb_subst_all.txt"),
            sep = "\t", row.names = TRUE)
```
-->

# Session information

The R version and packages used in this analysis are listed below.

```{r sessioninfo}
sessionInfo()
```
